;/*
; * usb_cdc_exec_echo.inc
; *
; *  Created: 30.12.2021 15:15:50
; *   Author: Dominik Koch
; */ 
.ifndef USB_CDC_EXEC_ECHO_INCLUDE
.set USB_CDC_EXEC_ECHO_INCLUDE = 1

CMD_ECHO:   .db "echo",0x00,0x00
CMD_ECHO1:  .db "_",0x00
CMD_ECHO2:  .db " ",0x00
CMD_ECHO_ON: .db "on",0x00,0x00
CMD_ECHO_OFF: .db "off",0x00

CMD_ECHO_ON_TEXT:  .db '\n',"@Echo On",'\n',0x00,0x00
CMD_ECHO_OFF_TEXT: .db '\n',"@Echo Off",'\n',0x00

CMD_ECHO_EXEC:
		;"echo_"
		COMMAND_PGM_EXEC CMD_ECHO1, CMD_ECHO1_EXEC  ; (PGM_CMD_STRING_POINTER, FUNCTION_POINTER)
		SBRC R0, 0		
		RJMP CMD_ECHO_EXEC_END

		;"echo "
		COMMAND_PGM_EXEC CMD_ECHO2, CMD_ECHO2_EXEC  ; (PGM_CMD_STRING_POINTER, FUNCTION_POINTER)
		SBRC R0, 0		
		RJMP CMD_ECHO_EXEC_END
CMD_ECHO_EXEC_END:
RET

CMD_ECHO1_EXEC:
		;"echo_on"
		COMMAND_PGM_EXEC CMD_ECHO_ON, CMD_ECHO_ON_EXEC  ; (PGM_CMD_STRING_POINTER, FUNCTION_POINTER)
		SBRC R0, 0		
		RJMP CMD_ECHO1_EXEC_END

		;"echo_off"
		COMMAND_PGM_EXEC CMD_ECHO_OFF, CMD_ECHO_OFF_EXEC  ; (PGM_CMD_STRING_POINTER, FUNCTION_POINTER)
		SBRC R0, 0		
		RJMP CMD_ECHO1_EXEC_END
CMD_ECHO1_EXEC_END:
RET

CMD_ECHO_ON_EXEC:
PUSH ZL
PUSH ZH
	CALL USB_CDC_ENABLE_ECHO
	LDI ZL,  LOW(CMD_ECHO_ON_TEXT)
	LDI ZH, HIGH(CMD_ECHO_ON_TEXT)
	CALL PRINT_PGM_STR ; Z = STR_POINTER
CMD_ECHO_ON_EXEC_END:
POP ZH
POP ZL
RET

CMD_ECHO_OFF_EXEC:
PUSH ZL
PUSH ZH
	CALL USB_CDC_DISABLE_ECHO
	LDI ZL,  LOW(CMD_ECHO_OFF_TEXT)
	LDI ZH, HIGH(CMD_ECHO_OFF_TEXT)
	CALL PRINT_PGM_STR ; Z = STR_POINTER
CMD_ECHO_OFF_EXEC_END:
POP ZH
POP ZL
RET

CMD_ECHO2_EXEC:
PUSH YL
PUSH YH	
PUSH ZL
PUSH ZH	
	MOVW Z, Y
	LDI YL,  LOW(USB_TX_BUFFER_P)
	LDI YH, HIGH(USB_TX_BUFFER_P)
	CALL USB_RAM_STR_TO_BUFFER ; Y = PUFFER_POINTER, Z = RAM_STR_POINTER
	CALL USB_CDC_TX_WAIT
CMD_ECHO2_EXEC_END:
POP ZH
POP ZL
POP YH
POP YL
RET

.endif